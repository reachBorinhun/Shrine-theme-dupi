{% comment %}
  Section: Full Screen Intro Gate (FIXED VIDEO VERSION)
  - A full-screen, fixed position section that acts as an entry gate to the site.
  - Features a dynamic background video/image, logo, and customizable button text.
  - On click, it smoothly transitions away to reveal the main page content.
{% endcomment %}

{%- liquid
  assign bg_image = section.settings.background_image
  assign logo_image = section.settings.logo_image
  assign button_text = section.settings.button_text | escape
  assign bg_video = section.settings.background_video
-%}

<style>
  #intro-gate-{{ section.id }} {
    overflow: hidden;

    {% if bg_video == blank and bg_image != blank %}
      background-image: url('{{ bg_image | image_url: width: 1920 }}');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    {% elsif bg_video == blank and bg_image == blank %}
      background-color: #000000;
    {% endif %}

    will-change: transform;
    transform: translate3d(0, 0, 0);
  }

  .intro-gate-content-{{ section.id }} {
    position: relative;
    z-index: 10;
    color: white;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.7);
  }

  .intro-gate-video-{{ section.id }} {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    min-width: 100%;
    min-height: 100%;
    width: auto;
    height: auto;
    object-fit: cover;
    z-index: 0;
  }

  /* Video overlay to darken if needed */
  .intro-gate-overlay-{{ section.id }} {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.3);
    z-index: 1;
  }

  .shine-button {
    position: relative;
    overflow: hidden;
  }

  .shine-button::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.35) 50%, rgba(255,255,255,0) 100%);
    transform: translateX(-100%);
    animation: shine-effect 3.5s infinite linear;
  }

  @keyframes shine-effect {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  #enter-button-{{ section.id }} {
    color: #f7f7f7;
  }

  #enter-button-{{ section.id }}:hover,
  #enter-button-{{ section.id }}:focus {
    color: #ffffff;
  }

  body.intro-gate-active {
    overflow: hidden;
  }

  #intro-gate-{{ section.id }}, #MainContent {
    transition-property: transform;
    transition-duration: 1.2s;
    transition-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
  }

  body.intro-gate-active #MainContent {
    transform: translate3d(0, 100vh, 0);
    pointer-events: none;
  }

  body.intro-gate-revealing #intro-gate-{{ section.id }} {
    transform: translate3d(0, -100vh, 0);
  }

  body.intro-gate-revealing #MainContent {
    transform: translate3d(0, 0, 0);
    pointer-events: auto;
    transition-delay: 0s;
  }

  /* Make logo image bigger on desktop screens */
  @media (min-width: 1090px) {
    .intro-gate-content-{{ section.id }} img {
      width: 180px !important;
      max-width: none;
    }
  }
</style>

<div
  id="intro-gate-{{ section.id }}"
  class="fixed top-0 left-0 w-screen h-screen bg-cover bg-center z-[100] flex justify-center items-end"
>
  {%- if bg_video != blank -%}
    {%- comment -%} Use Shopify's sources array for video URLs {%- endcomment -%}
    <video
      class="intro-gate-video-{{ section.id }}"
      autoplay
      loop
      muted
      playsinline
      {% if bg_image != blank %}
        poster="{{ bg_image | image_url: width: 1920 }}"
      {% endif %}
    >
      {%- for source in bg_video.sources -%}
        <source src="{{ source.url }}" type="{{ source.mime_type }}">
      {%- endfor -%}
      Your browser does not support the video tag.
    </video>
    <div class="intro-gate-overlay-{{ section.id }}"></div>
  {%- endif -%}

  <div class="intro-gate-content-{{ section.id }} text-center pb-[8vh]">
    {% if logo_image != blank %}
      {{
        logo_image
        | image_url: width: 240
        | image_tag:
          class: 'mx-auto w-[120px] h-auto mb-5 drop-shadow-lg',
          loading: 'eager',
          width: logo_image.width,
          height: logo_image.height,
          alt: logo_image.alt
        | default: 'Logo'
      }}
    {% else %}
      <div class="mx-auto w-[120px] h-[120px] mb-5 bg-white/10 rounded-full flex items-center justify-center border border-white/20">
        <span class="text-xs uppercase">Logo</span>
      </div>
    {% endif %}

    {% if button_text != blank %}
      <button
        id="enter-button-{{ section.id }}"
        type="button"
        class="text-xl font-medium text-gray-200 hover:text-white tracking-wider cursor-pointer shine-button animate-pulse px-4 py-2 focus:outline-none focus:ring-4 focus:ring-white/30"
        aria-label="Enter site"
      >
        {{ button_text }}
      </button>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const introGate = document.getElementById('intro-gate-{{ section.id }}');
    const enterButton = document.getElementById('enter-button-{{ section.id }}');
    const body = document.body;

    if (!introGate || !enterButton) return;

    // Prevent scrolling while gate is present
    body.classList.add('intro-gate-active');

    const reveal = () => {
      body.classList.add('intro-gate-revealing');

      let cleaned = false;
      const cleanup = () => {
        if (cleaned) return;
        cleaned = true;
        if (introGate.parentNode) introGate.parentNode.removeChild(introGate);
        body.classList.remove('intro-gate-active', 'intro-gate-revealing');
      };

      introGate.addEventListener('transitionend', function handler(e) {
        if (e.target !== introGate) return;
        introGate.removeEventListener('transitionend', handler);
        cleanup();
      });

      setTimeout(cleanup, 1400);
    };

    enterButton.addEventListener('click', reveal);
    enterButton.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        reveal();
      }
    });
  });
</script>

{% schema %}
{
  "name": "Full Screen Intro Gate",
  "settings": [
    {
      "type": "video",
      "id": "background_video",
      "label": "Background Video",
      "info": "Upload an .mp4 video. This will autoplay on loop and mute."
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Background Image (Fallback/Poster)",
      "info": "This image shows while video loads or if video fails to play."
    },
    {
      "type": "image_picker",
      "id": "logo_image",
      "label": "Logo Image",
      "info": "This logo will be displayed at the bottom-center of the screen."
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Click to Start"
    }
  ],
  "presets": [
    {
      "name": "Full Screen Intro Gate"
    }
  ],
  "enabled_on": {
    "templates": ["index"]
  }
}
{% endschema %}
