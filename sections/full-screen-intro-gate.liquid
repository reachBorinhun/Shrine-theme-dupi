{% comment %}
  Section: Full Screen Intro Gate (RESTORED ANIMATION + FLASH FIX)
  - Animation: Original slide-up (translate3d) restored.
  - Protection: Compatible with theme.liquid fix.
  - Logic: Auto-detects Store Logo.
{% endcomment %}

{%- liquid
  # --- LOGO LOGIC: Auto-detect Store Logo ---
  assign logo_image = section.settings.logo_image | default: settings.logo

  assign bg_image = section.settings.background_image
  assign button_text = section.settings.button_text | escape
  assign bg_video = section.settings.background_video
  assign mp4_url = section.settings.mp4_video_link

  assign loader_logo_id = 'loader-logo-' | append: section.id
-%}

{%- comment -%} LOADING SCREEN (The Black Overlay) {%- endcomment -%}
<div
  id="intro-gate-loader-{{ section.id }}"
  style="position:fixed;top:0;left:0;width:100%;height:100%;background:#232325;z-index:2147483647;display:flex;align-items:center;justify-content:center;transition:opacity 0.8s ease;"
>
  <div style="text-align:center;">
    {% if logo_image != blank %}
      {{
        logo_image
        | image_url: width: 300
        | image_tag:
          id: loader_logo_id,
          style: 'width:120px;height:auto;animation:pulse-logo 2s ease-in-out infinite;',
          loading: 'eager',
          alt: 'Loading...'
      }}
    {% else %}
      <!-- Fallback Spinner if NO logo exists -->
      <div
        style="width:50px;height:50px;border:4px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin-loader 1s linear infinite;"
      ></div>
    {% endif %}
  </div>
</div>

<style>
  /* --- ANIMATIONS --- */
  @keyframes pulse-logo {
    0%, 100% { opacity: 0.6; transform: scale(0.98); }
    50% { opacity: 1; transform: scale(1.02); }
  }
  @keyframes spin-loader {
    to { transform: rotate(360deg); }
  }

  /* --- ORIGINAL GATE STYLES RESTORED --- */
  #intro-gate-{{ section.id }} {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    z-index: 2147483646; /* Just below loader */
    display: flex;
    justify-content: center;
    align-items: flex-end;
    background-color: #232325; /* Ensure background exists when wrapper becomes transparent */

    {% if mp4_url == blank and bg_video == blank and bg_image != blank %}
      background-image: url('{{ bg_image | image_url: width: 1920 }}');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    {% elsif mp4_url == blank and bg_video == blank and bg_image == blank %}
      background-color: #000000;
    {% endif %}

    will-change: transform;
    transform: translate3d(0, 0, 0);
  }

  .intro-gate-content-{{ section.id }} {
    position: relative;
    z-index: 10;
    color: white;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.7);
    font-family: Helvetica, Arial, sans-serif;
    padding-bottom: 8vh;
    text-align: center;
  }

  .intro-gate-video-{{ section.id }} {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    min-width: 100%;
    min-height: 100%;
    width: auto;
    height: auto;
    object-fit: cover;
    z-index: 0;
  }

  .intro-gate-overlay-{{ section.id }} {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.3);
    z-index: 1;
  }

  .shine-button {
    position: relative;
    background: linear-gradient(110deg, #444 0%, #444 40%, #fff 50%, #444 60%, #444 100%);
    background-size: 200% auto;
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    color: transparent;
    animation: shine-text 3.5s infinite linear;
  }

  @keyframes shine-text {
    0% { background-position: 0% center; }
    100% { background-position: 200% center; }
  }

  #enter-button-{{ section.id }} {
    color: #f7f7f7;
    font-size: 1.7rem;
    font-weight: 600;
    font-family: Helvetica, Arial, sans-serif;
    cursor: pointer;
  }

  #enter-button-{{ section.id }}:hover,
  #enter-button-{{ section.id }}:focus {
    color: #ffffff;
  }

  /* --- REVEAL ANIMATION LOGIC (FROM YOUR OLD CODE) --- */
  body.intro-gate-active {
    overflow: hidden;
  }

  #intro-gate-{{ section.id }}, #MainContent {
    transition-property: transform;
    transition-duration: 1.2s;
    transition-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
  }

  body.intro-gate-active #MainContent {
    transform: translate3d(0, 100vh, 0);
    pointer-events: none;
    opacity: 1 !important; /* Force opacity back to 1 for the reveal */
    visibility: visible !important;
  }

  body.intro-gate-revealing #intro-gate-{{ section.id }} {
    transform: translate3d(0, -100vh, 0);
  }

  body.intro-gate-revealing #MainContent {
    transform: translate3d(0, 0, 0);
    pointer-events: auto;
    transition-delay: 0s;
  }

  @media (min-width: 1090px) {
    .intro-gate-content-{{ section.id }} img {
      width: 180px !important;
      max-width: none;
    }
  }
</style>

<div id="intro-gate-{{ section.id }}">
  {%- if mp4_url != blank -%}
    <video
      id="intro-video-{{ section.id }}"
      class="intro-gate-video-{{ section.id }}"
      src="{{ mp4_url }}"
      autoplay
      loop
      muted
      playsinline
      preload="auto"
      {% if bg_image != blank %}
        poster="{{ bg_image | image_url: width: 1920 }}"
      {% endif %}
    ></video>
    <div class="intro-gate-overlay-{{ section.id }}"></div>
  {%- elsif bg_video != blank -%}
    <video
      id="intro-video-{{ section.id }}"
      class="intro-gate-video-{{ section.id }}"
      autoplay
      loop
      muted
      playsinline
      preload="auto"
      {% if bg_image != blank %}
        poster="{{ bg_image | image_url: width: 1920 }}"
      {% endif %}
    >
      {%- for source in bg_video.sources -%}
        <source src="{{ source.url }}" type="{{ source.mime_type }}">
      {%- endfor -%}
    </video>
    <div class="intro-gate-overlay-{{ section.id }}"></div>
  {%- endif -%}

  <div class="intro-gate-content-{{ section.id }}">
    {% if logo_image != blank %}
      {{
        logo_image
        | image_url: width: 300
        | image_tag: class: 'mx-auto w-[120px] h-auto mb-5 drop-shadow-lg', loading: 'eager', alt: logo_image.alt
        | default: 'Logo'
      }}
    {% else %}
      <div class="mx-auto w-[120px] h-[120px] mb-5 bg-white/10 rounded-full flex items-center justify-center border border-white/20">
        <span class="text-xs uppercase">Logo</span>
      </div>
    {% endif %}

    {% if button_text != blank %}
      <button
        id="enter-button-{{ section.id }}"
        type="button"
        class="text-xl font-medium text-gray-200 hover:text-white tracking-wider cursor-pointer shine-button animate-pulse px-4 py-2 focus:outline-none focus:ring-4 focus:ring-white/30"
        aria-label="Enter site"
      >
        {{ button_text }}
      </button>
    {% endif %}
  </div>
</div>

<script>
  (function() {
  // 0. CHECK IF SEEN
  try {
    if (sessionStorage.getItem('intro_seen')) {
      const wrapper = document.querySelector('.intro-gate-wrapper');
      if (wrapper) wrapper.remove();
      return;
    }
  } catch(e) {}

  const loader = document.getElementById('intro-gate-loader-{{ section.id }}');
    const introGate = document.getElementById('intro-gate-{{ section.id }}');
    const enterButton = document.getElementById('enter-button-{{ section.id }}');
    const body = document.body;

    if (!introGate || !loader) return;

    // 1. LOADING LOGIC
    let resourcesLoaded = 0;
    const requiredResources = {% if mp4_url != blank or bg_video != blank %}2{% else %}1{% endif %};
    const startTime = Date.now();

    function hideLoader() {
      const elapsed = Date.now() - startTime;
      const minTime = 1000; // Minimum 1s load time for smoothness
      const delay = Math.max(0, minTime - elapsed);

      setTimeout(() => {
        // Fade out loader
        loader.style.opacity = '0';

        // Remove loader from DOM
        setTimeout(() => {
          if (loader.parentNode) loader.parentNode.removeChild(loader);
        }, 800);
      }, delay);
    }

    function markLoaded() {
      resourcesLoaded++;
      if (resourcesLoaded >= requiredResources) hideLoader();
    }

    // Check DOM
    if (document.readyState === 'complete') markLoaded();
    else window.addEventListener('load', markLoaded, { once: true });

    // Check Video
    {% if mp4_url != blank or bg_video != blank %}
      const video = document.getElementById('intro-video-{{ section.id }}');
      if (video) {
        if (video.readyState >= 3) markLoaded();
        else {
          video.addEventListener('canplaythrough', markLoaded, { once: true });
          video.addEventListener('error', markLoaded, { once: true });
        }
      } else markLoaded();
    {% endif %}

    // Timeout failsafe (4s)
    setTimeout(() => {
      if (loader.style.opacity !== '0') hideLoader();
    }, 4000);


    // 2. REVEAL LOGIC (Your Original Animation)


    const reveal = () => {
      body.classList.add('intro-gate-revealing');

    try { sessionStorage.setItem('intro_seen', 'true'); } catch(e) {}

    // Reset HTML background to allow scrolling again
      document.documentElement.style.background = '';
      document.body.style.background = '';
      document.documentElement.style.overflow = 'initial';
      document.body.style.overflow = 'initial';

      let cleaned = false;
      const cleanup = () => {
      if (cleaned) return;
      cleaned = true;
      const wrapper = introGate.closest('.intro-gate-wrapper');
      if (wrapper) wrapper.remove();
      else if (introGate.parentNode) introGate.remove();

      body.classList.remove('intro-gate-active', 'intro-gate-revealing');
    };

      introGate.addEventListener('transitionend', function handler(e) {
        if (e.target !== introGate) return;
        introGate.removeEventListener('transitionend', handler);
        cleanup();
      });

      setTimeout(cleanup, 1400);
    };

    introGate.addEventListener('click', reveal);

    if (enterButton) {
      enterButton.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          reveal();
        }
      });
    }
  })();
</script>

{% schema %}
{
  "name": "Full Screen Intro Gate",
  "settings": [
    {
      "type": "text",
      "id": "mp4_video_link",
      "label": "Direct MP4 Video Link",
      "info": "Paste the direct link from Content > Files here for best mobile quality."
    },
    {
      "type": "video",
      "id": "background_video",
      "label": "Background Video (Fallback)",
      "info": "Standard Shopify upload. Will be used if no Direct Link is provided."
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Background Image (Poster)",
      "info": "Shows while video loads."
    },
    {
      "type": "image_picker",
      "id": "logo_image",
      "label": "Logo Image (Optional)",
      "info": "If left blank, automatically uses your Store Header Logo."
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Click to Start"
    }
  ],
  "presets": [
    {
      "name": "Full Screen Intro Gate"
    }
  ],
  "enabled_on": {
    "templates": ["index"]
  }
}
{% endschema %}
